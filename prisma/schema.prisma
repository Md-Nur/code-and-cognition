generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/// Core User model representing both administrators and contractors.
model User {
  id               String          @id @default(cuid())
  name             String
  email            String          @unique
  passwordHash     String
  role             Role            @default(CONTRACTOR)
  createdAt        DateTime        @default(now())
  ledgerBalance    LedgerBalance?
  receivedMessages Message[]       @relation("ReceivedMessages")
  sentMessages     Message[]       @relation("SentMessages")
  notifications    Notification[]
  finderProjects   Project[]       @relation("Finder")
  memberProjects   ProjectMember[]
  activityLogs     ActivityLog[]
  changeRequests   ChangeRequest[]
}

/// Internal message system for communication between users.
model Message {
  id         String   @id @default(cuid())
  content    String
  senderId   String
  receiverId String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  sender     User     @relation("SentMessages", fields: [senderId], references: [id])
}

/// System notifications for users regarding bookings, projects, and payments.
model Notification {
  id        String           @id @default(cuid())
  userId    String
  title     String
  message   String
  type      NotificationType
  link      String? /// Optional link to redirect user (e.g., to a specific booking)
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id])
}

/// Main service offerings displayed on the landing page and services page.
model Service {
  id             String          @id @default(cuid())
  title          String          @unique
  slug           String          @unique
  description    String
  status         Status          @default(ACTIVE)
  thumbnailUrl   String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  bookings       Booking[]
  portfolioItems PortfolioItem[]
  subCategories  SubCategory[]
}

/// Specific sub-categories of services with their own pricing tiers.
model SubCategory {
  id                String          @id @default(cuid())
  title             String
  slug              String          @unique
  description       String?
  serviceId         String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  basePriceBDT      Float           @default(0)
  basePriceUSD      Float           @default(0)
  imageUrl          String?
  mediumPriceBDT    Float           @default(0)
  mediumPriceUSD    Float           @default(0)
  proPriceBDT       Float           @default(0)
  proPriceUSD       Float           @default(0)
  mediumDescription String?
  proDescription    String?
  portfolioItems    PortfolioItem[]
  service           Service         @relation(fields: [serviceId], references: [id], onDelete: Cascade)
}

/// Individual portfolio pieces shown in the portfolio section.
model PortfolioItem {
  id            String       @id @default(cuid())
  title         String
  description   String
  imageUrl      String?
  projectUrl    String?
  serviceId     String
  technologies  String[]
  isFeatured    Boolean      @default(false)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  subCategoryId String?
  service       Service      @relation(fields: [serviceId], references: [id])
  subCategory   SubCategory? @relation(fields: [subCategoryId], references: [id])
}

/// Client bookings/leads submitted from the contact or service forms.
model Booking {
  id          String        @id @default(cuid())
  clientName  String
  clientEmail String
  clientPhone String?
  serviceId   String
  budgetBDT   Float?
  budgetUSD   Float?
  message     String?
  status      BookingStatus @default(PENDING)
  createdAt   DateTime      @default(now())
  service     Service       @relation(fields: [serviceId], references: [id])
  project     Project?
}

/// Active projects managed by the agency, converted from bookings.
model Project {
  id             String          @id @default(cuid())
  title          String
  bookingId      String?         @unique
  finderId       String /// The user who brought in the project
  status         ProjectStatus   @default(ACTIVE)
  health         ProjectHealth   @default(GREEN)
  viewToken      String?         @unique @default(uuid()) /// Public viewing token for clients
  scope          String? /// Project scope and objectives
  startDate      DateTime? /// Project start date
  endDate        DateTime? /// Project end date / deadline
  riskNotes      String? /// Risk management notes
  createdAt      DateTime        @default(now())
  payments       Payment[]
  booking        Booking?        @relation(fields: [bookingId], references: [id])
  finder         User            @relation("Finder", fields: [finderId], references: [id])
  members        ProjectMember[]
  milestones     Milestone[]
  activityLogs   ActivityLog[]
  changeRequests ChangeRequest[]
}

/// Contractors assigned to a project with their respective execution share (percentage).
model ProjectMember {
  id        String  @id @default(cuid())
  projectId String
  userId    String
  share     Float /// Percentage share of execution earnings
  project   Project @relation(fields: [projectId], references: [id])
  user      User    @relation(fields: [userId], references: [id])

  @@unique([projectId, userId])
}

/// Financial payments received for a project.
model Payment {
  id        String        @id @default(cuid())
  projectId String
  amountBDT Float?
  amountUSD Float?
  currency  Currency
  note      String?
  paidAt    DateTime      @default(now())
  splits    LedgerEntry[] /// Automatic splits generated for founders and project members
  project   Project       @relation(fields: [projectId], references: [id])
}

/// Detailed ledger entries for each payment split (e.g., Company, Finder Fee, Execution).
model LedgerEntry {
  id        String    @id @default(cuid())
  paymentId String
  userId    String? /// Null for COMPANY_FUND
  type      SplitType
  amountBDT Float?
  amountUSD Float?
  createdAt DateTime  @default(now())
  payment   Payment   @relation(fields: [paymentId], references: [id])
}

/// Running totals of earnings for each user.
model LedgerBalance {
  id       String @id @default(cuid())
  userId   String @unique
  totalBDT Float  @default(0)
  totalUSD Float  @default(0)
  user     User   @relation(fields: [userId], references: [id])
}

/// Customer testimonials displayed on the landing page.
model Testimonial {
  id        String   @id @default(cuid())
  name      String
  role      String?
  company   String?
  content   String
  avatarUrl String?
  rating    Int      @default(5)
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Partner or client logos shown in the client section.
model Client {
  id        String   @id @default(cuid())
  name      String
  logoUrl   String
  website   String?
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Business expenses recorded for profit/revenue tracking.
model Expense {
  id        String   @id @default(cuid())
  title     String
  amountBDT Float
  amountUSD Float?
  category  String?
  date      DateTime @default(now())
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum NotificationType {
  BOOKING_NEW
  BOOKING_STATUS_CHANGE
  PROJECT_NEW
  PROJECT_STATUS_CHANGE
  MESSAGE_NEW
  PAYMENT_RECEIVED
  SYSTEM
}

enum Role {
  FOUNDER
  CONTRACTOR
  CLIENT
}

enum Status {
  ACTIVE
  INACTIVE
}

enum BookingStatus {
  PENDING
  REVIEWED
  CONVERTED
  REJECTED
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum Currency {
  BDT
  USD
}

enum SplitType {
  COMPANY_FUND
  FINDER_FEE
  EXECUTION
}

enum ProjectHealth {
  GREEN
  YELLOW
  RED
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

/// Project milestones for tracking progress and deliverables.
model Milestone {
  id          String          @id @default(cuid())
  projectId   String
  title       String
  description String?
  order       Int             @default(0)
  status      MilestoneStatus @default(PENDING)
  completedAt DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  project     Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

/// Audit trail of events and actions performed on projects.
model ActivityLog {
  id        String   @id @default(cuid())
  projectId String
  userId    String?
  action    String
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
}

/// Client-initiated or founder-created change requests within a project.
model ChangeRequest {
  id                    String    @id @default(cuid())
  projectId             String
  requestedById         String
  title                 String
  description           String
  estimatedTimeImpact   Float     @default(0) /// In hours
  estimatedBudgetImpact Float     @default(0) /// In project currency
  status                CRStatus  @default(PENDING)
  clientApprovalAt      DateTime?
  createdAt             DateTime  @default(now())
  project               Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  requestedBy           User      @relation(fields: [requestedById], references: [id])
}

enum CRStatus {
  PENDING
  APPROVED
  REJECTED
}
